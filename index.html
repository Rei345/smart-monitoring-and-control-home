<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IoT Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/adminlte.min.css">
</head>
<body class="hold-transition dark-mode">
    <div class="wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-12">
                        <h1 class="m-0">Smart Home Monitoring & Control</h1>
                    </div>
                </div>
            </div>
        </div>
        <section class="content">
            <div class="container-fluid">
                <div class="row">
    
                    <div class="col-lg-8">
                        <div class="row">
                            <div class="col-lg-6"><div class="info-box"><span class="info-box-icon bg-info"><i class="fas fa-temperature-high"></i></span><div class="info-box-content"><span class="info-box-text">Temperature</span><span class="info-box-number" id="hitTEMP">N/A °C</span></div></div></div>
                            <div class="col-lg-6"><div class="info-box"><span class="info-box-icon bg-danger"><i class="fas fa-tint"></i></span><div class="info-box-content"><span class="info-box-text">Humidity</span><span class="info-box-number" id="hitHUM">N/A %</span></div></div></div>
                            <div class="col-lg-6"><div class="info-box"><span class="info-box-icon bg-secondary"><i class="fas fa-tachometer-alt"></i></span><div class="info-box-content"><span class="info-box-text">Pressure</span><span class="info-box-number" id="pressure">N/A hPa</span></div></div></div>
                            <div class="col-lg-6"><div class="info-box"><span class="info-box-icon bg-warning"><i class="fas fa-mountain"></i></span><div class="info-box-content"><span class="info-box-text">Height</span><span class="info-box-number" id="height">N/A m</span></div></div></div>
                            <div class="col-lg-6"><div class="info-box"><span class="info-box-icon bg-success"><i class="fas fa-ruler-horizontal"></i></span><div class="info-box-content"><span class="info-box-text">Door Distance</span><span class="info-box-number" id="doorDistance">N/A cm</span></div></div></div>
                            <div class="col-lg-6"><div class="info-box bg-primary" id="doorStatusBox"><span class="info-box-icon"><i class="fas fa-door-closed"></i></span><div class="info-box-content"><span class="info-box-text">Door Status</span><span class="info-box-number" id="doorStatus">UNKNOWN</span></div></div></div>
                            <div class="col-lg-12"><div class="info-box bg-dark" id="fanStatusBox"><span class="info-box-icon"><i class="fas fa-fan"></i></span><div class="info-box-content"><span class="info-box-text">Fan Status</span><span class="info-box-number" id="fanStatus">OFF</span></div></div></div>
                        </div>
    
                        <div class="row">
                            <div class="col-md-6"><div class="card"><div class="card-header"><h5 class="card-title"><i class="fas fa-chart-bar"></i> Temperature (BMP280)</h5></div><div class="card-body"><canvas id="chartTEMP" height="180"></canvas></div></div></div>
                            <div class="col-md-6"><div class="card"><div class="card-header"><h5 class="card-title"><i class="fas fa-chart-bar"></i> Humidity (DHT11)</h5></div><div class="card-body"><canvas id="chartHUM" height="180"></canvas></div></div></div>
                            <div class="col-md-6"><div class="card"><div class="card-header"><h5 class="card-title"><i class="fas fa-chart-line"></i> Pressure (BMP280)</h5></div><div class="card-body"><canvas id="chartPRESSURE" height="180"></canvas></div></div></div>
                            <div class="col-md-6"><div class="card"><div class="card-header"><h5 class="card-title"><i class="fas fa-chart-line"></i> Height (BMP280)</h5></div><div class="card-body"><canvas id="chartHEIGHT" height="180"></canvas></div></div></div>
                        </div>
                    </div>
    
                    <div class="col-lg-4">
                        <div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-door-open"></i> Kontrol Pintu Manual</h3></div><div class="card-body text-center"><button type="button" class="btn btn-success" onclick="controlServo('BUKA')">Buka Pintu</button><button type="button" class="btn btn-danger" onclick="controlServo('TUTUP')">Tutup Pintu</button></div></div>
                        <div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-fan"></i> Kontrol Kipas Manual</h3></div><div class="card-body text-center"><button class="btn btn-success" onclick="controlFan('ON')">Nyalakan Kipas</button><button class="btn btn-danger" onclick="controlFan('OFF')">Matikan Kipas</button></div></div>
                        <div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-clock"></i> Penjadwalan Pintu Harian</h3></div><div class="card-body"><div class="form-group"><label for="openTime">Waktu Buka:</label><input type="time" id="openTime" class="form-control" value="08:00"></div><div class="form-group"><label for="closeTime">Waktu Tutup:</label><input type="time" id="closeTime" class="form-control" value="17:00"></div><button type="button" class="btn btn-primary btn-block" onclick="saveSchedule()">Simpan Jadwal</button></div></div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12"><div class="alert alert-success alert-dismissible"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><h5><i class="icon fas fa-info"></i> <strong>Status Koneksi Broker MQTT</strong></h5><div id="messages"></div></div></div>
                </div>
            </div>
        </section>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@1.9.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

<script>
    // --- KONFIGURASI MQTT ---
    var host = "10.55.216.94"; // PASTIKAN IP INI ADALAH IP LAPTOP ANDA!
    var port = 9001;
    var client = new Paho.MQTT.Client(host, port, "/ws", "dashboard_" + parseInt(Math.random() * 100, 10));

    // --- VARIABEL GLOBAL UNTUK MENYIMPAN DATA SENSOR TERAKHIR ---
    var temp = 0, humi = 0, pressure = 0, height = 0;

    // --- TOPIC MQTT (Sudah disamakan) ---
    const BASE_TOPIC = "sistem_monitoring_matkul_mikroprosesor";
    const TOPIC_SENSOR = `${BASE_TOPIC}/sensor`;
    const TOPIC_PINTU_STATUS = `${BASE_TOPIC}/door/status`;
    const TOPIC_KIPAS_STATUS = `${BASE_TOPIC}/fan/status`;
    const TOPIC_PINTU_MANUAL = `${BASE_TOPIC}/pintu/manual`;
    const TOPIC_KIPAS_MANUAL = `${BASE_TOPIC}/kipas/manual`;
    const TOPIC_PINTU_JADWAL = `${BASE_TOPIC}/pintu/jadwal`;

    // --- FUNGSI-FUNGSI MQTT ---
    client.onConnectionLost = (responseObject) => {
        document.getElementById("messages").innerHTML += `Koneksi Putus: ${responseObject.errorMessage}<br/>`;
    };

    client.onMessageArrived = (message) => {
        try {
            const topic = message.destinationName;
            const payload = JSON.parse(message.payloadString);

            if (topic === TOPIC_SENSOR) {
                // 1. Update variabel global (sumber data untuk grafik)
                temp = payload.suhu;
                humi = payload.kelembaban;
                pressure = payload.tekanan;
                height = payload.ketinggian;
                
                // 2. Update Info Box
                document.getElementById("hitTEMP").innerHTML = `${payload.suhu.toFixed(2)} °C`;
                document.getElementById("hitHUM").innerHTML = `${payload.kelembaban.toFixed(2)} %`;
                document.getElementById("pressure").innerHTML = `${payload.tekanan.toFixed(2)} hPa`;
                document.getElementById("height").innerHTML = `${payload.ketinggian.toFixed(2)} m`;
                document.getElementById("doorDistance").innerHTML = `${payload.jarak_pintu.toFixed(2)} cm`;
            } else if (topic === TOPIC_PINTU_STATUS) {
                document.getElementById("doorStatus").innerHTML = payload.door_state;
            } else if (topic === TOPIC_KIPAS_STATUS) {
                document.getElementById("fanStatus").innerHTML = payload.fan_state;
            }
        } catch (e) {
            console.error("Gagal parse JSON atau update UI:", e);
        }
    };

    var options = {
        timeout: 3,
        keepAliveInterval: 30,
        onSuccess: () => {
            document.getElementById("messages").innerHTML += "Koneksi Ke Broker MQTT Sukses<br/>";
            client.subscribe(`${BASE_TOPIC}/#`, { qos: 1 });
        },
        onFailure: (message) => {
            document.getElementById("messages").innerHTML += `Koneksi Gagal: ${message.errorMessage}<br/>`;
        },
        userName: "AdminMQTT",
        password: "pwd123"
    };
    client.connect(options);

    // --- FUNGSI KONTROL AKTUATOR (Tidak ada perubahan) ---
    function controlServo(action) { if (client.isConnected()) client.send(TOPIC_PINTU_MANUAL, action, 1, false); }
    function controlFan(action) { if (client.isConnected()) client.send(TOPIC_KIPAS_MANUAL, action, 1, false); }
    function saveSchedule() {
        if (client.isConnected()) {
            const schedule = { open: document.getElementById("openTime").value, close: document.getElementById("closeTime").value };
            client.send(TOPIC_PINTU_JADWAL, JSON.stringify(schedule), 1, false);
            document.getElementById("messages").innerHTML += `Jadwal dikirim: ${JSON.stringify(schedule)}<br/>`;
        }
    }

    // --- KONFIGURASI GRAFIK (Menggunakan Pola dari Kode Lama Anda) ---
    const chartColors = { red: 'rgb(255, 99, 132)', blue: 'rgb(54, 162, 235)', green: 'rgb(75, 192, 192)', yellow: 'rgb(255, 205, 86)' };

    // Konfigurasi umum untuk sumbu X realtime
    const realtimeAxis = {
        type: 'realtime',
        realtime: { duration: 20000, refresh: 2000, delay: 2000 }
    };

    // Fungsi-fungsi onRefresh untuk setiap grafik
    function onRefreshTemp(chart) { chart.data.datasets[0].data.push({ x: Date.now(), y: temp }); }
    function onRefreshHum(chart) { chart.data.datasets[0].data.push({ x: Date.now(), y: humi }); }
    function onRefreshPressure(chart) { chart.data.datasets[0].data.push({ x: Date.now(), y: pressure }); }
    function onRefreshHeight(chart) { chart.data.datasets[0].data.push({ x: Date.now(), y: height }); }

    // Objek konfigurasi untuk setiap grafik
    const configTEMP = { type: 'bar', data: { datasets: [{ label: 'Temperatur (°C)', backgroundColor: chartColors.red, data: [] }] }, options: { scales: { xAxes: [{ ...realtimeAxis, realtime: { ...realtimeAxis.realtime, onRefresh: onRefreshTemp } }], yAxes: [{ ticks: { beginAtZero: true } }] } } };
    const configHUM = { type: 'bar', data: { datasets: [{ label: 'Kelembaban (%)', backgroundColor: chartColors.blue, data: [] }] }, options: { scales: { xAxes: [{ ...realtimeAxis, realtime: { ...realtimeAxis.realtime, onRefresh: onRefreshHum } }], yAxes: [{ ticks: { beginAtZero: true } }] } } };
    const configPRESSURE = { type: 'line', data: { datasets: [{ label: 'Tekanan (hPa)', backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: chartColors.green, data: [] }] }, options: { scales: { xAxes: [{ ...realtimeAxis, realtime: { ...realtimeAxis.realtime, onRefresh: onRefreshPressure } }], yAxes: [{ ticks: { beginAtZero: false } }] } } };
    const configHEIGHT = { type: 'line', data: { datasets: [{ label: 'Ketinggian (m)', backgroundColor: 'rgba(255, 205, 86, 0.5)', borderColor: chartColors.yellow, data: [] }] }, options: { scales: { xAxes: [{ ...realtimeAxis, realtime: { ...realtimeAxis.realtime, onRefresh: onRefreshHeight } }], yAxes: [{ ticks: { beginAtZero: false } }] } } };

    // --- INISIALISASI SEMUA GRAFIK SAAT HALAMAN DIMUAT ---
    window.onload = function() {
        new Chart(document.getElementById('chartTEMP').getContext('2d'), configTEMP);
        new Chart(document.getElementById('chartHUM').getContext('2d'), configHUM);
        new Chart(document.getElementById('chartPRESSURE').getContext('2d'), configPRESSURE);
        new Chart(document.getElementById('chartHEIGHT').getContext('2d'), configHEIGHT);
    };
</script>
</body>
</html>